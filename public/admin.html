<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - QUSIS ãƒ‡ãƒ¢ãƒ‡ã‚¤</title>
    <script src="js/header.js"></script>
    <style>
        /* ğŸš€ æœ€é©åŒ–: CSSãƒªã‚»ãƒƒãƒˆã‚’æœ€å°åŒ– */
        *{margin:0;padding:0;box-sizing:border-box}
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f9fafb;
            color: #111827;
            line-height: 1.5;
        }
        
        .container {
            max-width: 80rem;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .header {
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        @media (min-width: 640px) {
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header-icon {
            width: 2.5rem;
            height: 2.5rem;
            background: #eab308;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-icon svg {
            width: 1.5rem;
            height: 1.5rem;
            color: white;
        }
        
        .header-text h1 {
            font-size: 1.875rem;
            font-weight: bold;
        }
        
        .header-text p {
            color: #6b7280;
        }
        
        .reset-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #fef2f2;
            color: #b91c1c;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        
        .reset-button:hover {
            background: #fecaca;
        }
        
        .reset-icon {
            width: 1rem;
            height: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .stat-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .stat-content p:first-child {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        
        .stat-value {
            font-size: 1.875rem;
            font-weight: bold;
        }
        
        .stat-icon {
            width: 2rem;
            height: 2rem;
        }
        
        .stat-icon.green { color: #16a34a; }
        .stat-icon.blue { color: #2563eb; }
        .stat-icon.purple { color: #7c3aed; }
        .stat-icon.orange { color: #ea580c; }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        @media (min-width: 1024px) {
            .main-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .panel {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .panel-icon {
            width: 1.25rem;
            height: 1.25rem;
        }
        
        .panel-icon.purple { color: #7c3aed; }
        .panel-icon.green { color: #16a34a; }
        .panel-icon.gray { color: #6b7280; }
        .panel-icon.blue { color: #2563eb; }
        
        .panel-title {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .panel-content {
            padding: 1.5rem;
        }
        
        /* ğŸš€ æœ€é©åŒ–: ãƒ”ãƒƒãƒã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«çµ±åˆ */
        .pitch-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: #fafafa;
        }

        .pitch-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .pitch-info { flex: 1; }

        .pitch-title {
            font-size: 1.125rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .pitch-team {
            font-size: 0.875rem;
            color: #7c3aed;
            margin-bottom: 0.25rem;
        }

        .pitch-presenter {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .pitch-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }

        .pitch-stats .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .pitch-stats .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .pitch-stats .stat-value {
            font-size: 1rem;
            font-weight: 600;
        }

        .pitch-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* ğŸš€ æœ€é©åŒ–: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã®çµ±åˆ */
        .status-badge.status-upcoming { background: #dbeafe; color: #1e40af; }
        .status-badge.status-live { background: #fef2f2; color: #dc2626; animation: pulse 2s infinite; }
        .status-badge.status-ended { background: #f3f4f6; color: #6b7280; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ğŸš€ æœ€é©åŒ–: ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã®çµ±åˆ */
        .btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            border: none;
        }
        
        .btn-start { background: #16a34a; color: white; }
        .btn-start:hover { background: #15803d; }
        .btn-end { background: #dc2626; color: white; }
        .btn-end:hover { background: #b91c1c; }
        .btn-delete { background: #fef2f2; color: #b91c1c; }
        .btn-delete:hover { background: #fecaca; }
        .btn-restart { background: #f59e0b; color: white; }
        .btn-restart:hover { background: #d97706; }
        
        .btn-icon { width: 0.75rem; height: 0.75rem; }
        
        /* ğŸš€ æœ€é©åŒ–: è²¢çŒ®ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«çµ±åˆ */
        .contribution-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .contribution-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .contribution-avatar {
            width: 2.5rem;
            height: 2.5rem;
            background: #f0fdfa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .contribution-avatar svg {
            width: 1.25rem;
            height: 1.25rem;
            color: #14b8a6;
        }
        
        .contribution-info {
            display: flex;
            flex-direction: column;
        }
        
        .contribution-user {
            font-weight: 500;
        }
        
        .contribution-details {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .contribution-time {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .contribution-amount {
            font-size: 1.125rem;
            font-weight: bold;
            color: #14b8a6;
        }
        
        /* ğŸš€ æœ€é©åŒ–: ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ã®çµ±åˆ */
        .user-table { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; }
        th {
            padding: 0.75rem 1.5rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        tbody { background: white; }
        td {
            padding: 1rem 1.5rem;
            white-space: nowrap;
            border-bottom: 1px solid #e5e7eb;
        }
        tr:hover { background: #f9fafb; }
        
        .role-badges {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .role-admin { background: #fef2f2; color: #b91c1c; }
        .role-presenter { background: #f0fdf4; color: #166534; }
        .role-viewer { background: #dbeafe; color: #1e40af; }
        .team-badge { background: #f3e8ff; color: #7c3aed; }
        
        .balance {
            color: #16a34a;
            font-weight: 600;
        }
        
        .delete-user-btn {
            color: #dc2626;
            background: none;
            border: none;
            padding: 0.25rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .delete-user-btn:hover {
            background: #fef2f2;
            color: #b91c1c;
        }
        
        .delete-user-icon { width: 1rem; height: 1rem; }
        .admin-label { color: #9ca3af; font-size: 0.875rem; }
        
        .empty-state {
            text-align: center;
            padding: 2rem 0;
            color: #6b7280;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 2rem;
            height: 2rem;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #14b8a6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden { display: none; }

        /* ğŸš€ æœ€é©åŒ–: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®çµ±åˆ */
        @media (max-width: 640px) {
            .pitch-header { flex-direction: column; gap: 1rem; }
            .pitch-actions { justify-content: center; }
            .pitch-stats { grid-template-columns: 1fr; gap: 0.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div class="header-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                        </svg>
                    </div>
                    <div class="header-text">
                        <h1>QUcoin é‹å–¶ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                        <p>QUSIS ã‚¼ãƒ­ã‚¤ãƒãƒ”ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</p>
                    </div>
                </div>
                <button class="reset-button" onclick="handleResetHistory()">
                    <svg class="reset-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <span>å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</span>
                </button>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-content">
                        <p>ç·ã‚®ãƒ•ãƒˆé¡</p>
                        <p class="stat-value" id="total-gifts">0 QUcoin</p>
                    </div>
                    <svg class="stat-icon green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <p>ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</p>
                        <p class="stat-value" id="total-users">0 äºº</p>
                    </div>
                    <svg class="stat-icon blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                    </svg>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <p>ç™»éŒ²æ¸ˆã¿ãƒ”ãƒƒãƒæ•°</p>
                        <p class="stat-value" id="total-pitches">0 ä»¶</p>
                    </div>
                    <svg class="stat-icon purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                </div>
            </div>

            <div class="main-grid">
                <!-- Pitch Management Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <svg class="panel-icon purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <h2 class="panel-title">ãƒ”ãƒƒãƒç®¡ç†</h2>
                    </div>
                    <div class="panel-content">
                        <div id="pitches-list">
                            <!-- Pitches will be inserted here -->
                        </div>
                        <div id="empty-pitches" class="empty-state hidden">
                            ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ”ãƒƒãƒã¯ã‚ã‚Šã¾ã›ã‚“
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Contribution History -->
            <div class="panel" style="margin-bottom: 2rem;">
                <div class="panel-header">
                    <svg class="panel-icon gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h2 class="panel-title">æ™‚é–“è²¢çŒ®å±¥æ­´</h2>
                </div>
                <div class="panel-content">
                    <div id="contributions-list">
                        <!-- Contributions will be inserted here -->
                    </div>
                    <div id="empty-contributions" class="empty-state hidden">
                        æ™‚é–“è²¢çŒ®ã‚’è¡Œã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã¾ã ã„ã¾ã›ã‚“
                    </div>
                </div>
            </div>

            <!-- User Management -->
            <div class="panel">
                <div class="panel-header">
                    <svg class="panel-icon blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                    </svg>
                    <h2 class="panel-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
                </div>
                <div class="panel-content">
                    <div class="user-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                    <th>ãƒ¡ãƒ¼ãƒ«</th>
                                    <th>æ®‹é«˜</th>
                                    <th>ç™»éŒ²æ—¥</th>
                                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Users will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸš€ æœ€é©åŒ–: ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®åˆæœŸåŒ–ã‚’åŠ¹ç‡åŒ–
        let currentUser = null;
        let pitches = [];
        let users = [];
        let recentGifts = [];
        let timeContributions = [];
        let socket = null;

        // ğŸš€ æœ€é©åŒ–: è»½é‡ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ 
        const dataCache = new Map();
        const CACHE_DURATION = 60000; // 1åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥

        // ğŸš€ æœ€é©åŒ–: é«˜é€ŸåŒ–ã•ã‚ŒãŸèªè¨¼ãƒã‚§ãƒƒã‚¯
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const userStr = localStorage.getItem('user');
            
            if (!token || !userStr) {
                window.location.href = 'login.html';
                return false;
            }
            
            try {
                currentUser = JSON.parse(userStr);
                if (currentUser.role !== 'admin') {
                    alert('ã“ã®ãƒšãƒ¼ã‚¸ã¯ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™');
                    window.location.href = 'home.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è§£æã«å¤±æ•—:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
                return false;
            }
        }

        // ğŸš€ æœ€é©åŒ–: çµ±åˆã‚­ãƒ£ãƒƒã‚·ãƒ¥é–¢æ•°
        function getCachedData(key) {
            const cached = dataCache.get(key);
            if (cached && (Date.now() - cached.timestamp) < CACHE_DURATION) {
                return cached.data;
            }
            dataCache.delete(key);
            return null;
        }

        function setCachedData(key, data) {
            dataCache.set(key, { data, timestamp: Date.now() });
        }

        // ğŸš€ æœ€é©åŒ–: ç®¡ç†è€…çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰
        async function loadAdminStats() {
            try {
                const token = localStorage.getItem('authToken');
                const headers = {
                    'x-user-id': token,
                    'Content-Type': 'application/json'
                };
                
                // ğŸš€ ä¸¦åˆ—ã§APIå‘¼ã³å‡ºã—ï¼ˆé«˜é€ŸåŒ–ï¼‰
                const [giftsResponse, usersResponse, pitchesResponse, contributionsResponse] = await Promise.allSettled([
                    fetch('/api/admin/total-coins', { headers }),
                    fetch('/api/admin/users', { headers }),
                    fetch('/api/pitches', { headers }),
                    fetch('/api/admin/time-contributions', { headers })
                ]);
                
                // ğŸš€ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¸¦åˆ—å‡¦ç†
                const processResponse = async (response, key, updateFunction) => {
                    if (response.status === 'fulfilled' && response.value.ok) {
                        const data = await response.value.json();
                        setCachedData(key, data);
                        updateFunction(data);
                    }
                };
                
                await Promise.all([
                    processResponse(giftsResponse, 'gifts', updateGiftsDisplay),
                    processResponse(usersResponse, 'users', updateUsersDisplay),
                    processResponse(pitchesResponse, 'pitches', updatePitchesDisplay),
                    processResponse(contributionsResponse, 'contributions', updateContributionsDisplay)
                ]);
                
                // ã‚µãƒ³ãƒ—ãƒ«ã‚®ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã¯æœ€å¾Œã«èª­ã¿è¾¼ã¿
                loadRecentGifts();
                
            } catch (error) {
                console.error('ç®¡ç†è€…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ğŸš€ æœ€é©åŒ–: å„è¡¨ç¤ºæ›´æ–°é–¢æ•°ã‚’åŠ¹ç‡åŒ–
        function updateGiftsDisplay(data) {
            const el = document.getElementById('total-gifts');
            if (el) el.textContent = `${data.total.toLocaleString()} QUcoin`;
        }

        function updateUsersDisplay(data) {
            users = data;
            const el = document.getElementById('total-users');
            if (el) el.textContent = `${users.length} äºº`;
            displayUsers();
        }

        function updatePitchesDisplay(data) {
            pitches = data;
            updatePitchStats();
            displayEvents();
        }

        function updateContributionsDisplay(data) {
            timeContributions = data;
            displayContributions();
        }

        // ğŸš€ æœ€é©åŒ–: ãƒ”ãƒƒãƒçµ±è¨ˆã‚’æ›´æ–°ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§å‡¦ç†ï¼‰
        function updatePitchStats() {
            const totalPitchesEl = document.getElementById('total-pitches');
            if (totalPitchesEl) {
                totalPitchesEl.textContent = `${pitches.length} ä»¶`;
            }
        }

        // ğŸš€ æœ€é©åŒ–: ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆDocumentFragmentä½¿ç”¨ï¼‰
        function displayEvents() {
            const container = document.getElementById('pitches-list');
            const emptyState = document.getElementById('empty-pitches');
            
            if (!container || !emptyState) return;

            if (pitches.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            // ğŸš€ DocumentFragmentã‚’ä½¿ç”¨ï¼ˆé«˜é€ŸåŒ–ï¼‰
            const fragment = document.createDocumentFragment();
            
            pitches.forEach(pitch => {
                fragment.appendChild(createPitchElement(pitch));
            });
            
            container.innerHTML = '';
            container.appendChild(fragment);
        }

        // ğŸš€ æœ€é©åŒ–: ãƒ”ãƒƒãƒè¦ç´ ã‚’ä½œæˆï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«æœ€é©åŒ–ï¼‰
        function createPitchElement(pitch) {
            const div = document.createElement('div');
            div.className = 'pitch-item';
            
            const statusInfo = getStatusInfo(pitch.status);
            
            div.innerHTML = `
                <div class="pitch-header">
                    <div class="pitch-info">
                        <h3 class="pitch-title">${pitch.title}</h3>
                        <p class="pitch-team">ãƒãƒ¼ãƒ : ${pitch.team || 'æœªè¨­å®š'}</p>
                    </div>
                    <span class="status-badge ${statusInfo.className}">${statusInfo.label}</span>
                </div>
                
                <div class="pitch-stats">
                    <div class="stat-item">
                        <span class="stat-label">ã‚®ãƒ•ãƒˆç·é¡</span>
                        <span class="stat-value">${pitch.totalTips || 0} QU</span>
                    </div>
                </div>
                
                <div class="pitch-actions">
                    ${getStatusButtons(pitch)}
                    <button class="btn btn-delete" onclick="handleDeletePitch('${pitch._id}', '${pitch.title}')">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        å‰Šé™¤
                    </button>
                </div>
            `;
            
            return div;
        }

        // ğŸš€ æœ€é©åŒ–: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã‚’å–å¾—ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
        const statusConfig = {
            live: { label: 'ãƒ©ã‚¤ãƒ–ä¸­', className: 'status-live' },
            ended: { label: 'çµ‚äº†', className: 'status-ended' },
            upcoming: { label: 'æœªé–‹å§‹', className: 'status-upcoming' }
        };

        function getStatusInfo(status) {
            return statusConfig[status] || statusConfig.upcoming;
        }

        // ğŸš€ æœ€é©åŒ–: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³ã‚’å–å¾—ï¼ˆé…åˆ—ã§ç®¡ç†ï¼‰
        function getStatusButtons(pitch) {
            const buttonMap = {
                upcoming: `
                    <button class="btn btn-start" onclick="handleStatusChange('${pitch._id}', 'live')">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-10-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        é–‹å§‹
                    </button>`,
                live: `
                    <button class="btn btn-end" onclick="handleStatusChange('${pitch._id}', 'ended')">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        çµ‚äº†
                    </button>`,
                ended: `
                    <button class="btn btn-restart" onclick="handleStatusChange('${pitch._id}', 'upcoming')">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        ãƒªã‚»ãƒƒãƒˆ
                    </button>`
            };
            
            return buttonMap[pitch.status] || '';
        }

        // ğŸš€ æœ€é©åŒ–: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°å„ªå…ˆï¼‰
        async function handleStatusChange(pitchId, newStatus) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/pitches/${pitchId}`, {
                    method: 'PUT',
                    headers: {
                        'x-user-id': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    // ğŸš€ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å³åº§ã«æ›´æ–°
                    const index = pitches.findIndex(p => p._id === pitchId);
                    if (index !== -1) {
                        pitches[index].status = newStatus;
                        setCachedData('pitches', pitches);
                        displayEvents(); // å³åº§ã«UIæ›´æ–°
                    }
                    
                    const statusText = { upcoming: 'æœªé–‹å§‹', live: 'ãƒ©ã‚¤ãƒ–ä¸­', ended: 'çµ‚äº†' };
                    alert(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${statusText[newStatus]}ã€ã«æ›´æ–°ã—ã¾ã—ãŸ`);
                } else {
                    alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ğŸš€ æœ€é©åŒ–: ãƒ”ãƒƒãƒå‰Šé™¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°å„ªå…ˆï¼‰
        async function handleDeletePitch(pitchId, title) {
            if (!confirm(`ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚é–¢é€£ã™ã‚‹æŠ•ã’éŠ­ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/pitches/${pitchId}`, {
                    method: 'DELETE',
                    headers: {
                        'x-user-id': token,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // ğŸš€ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å³åº§ã«æ›´æ–°
                    pitches = pitches.filter(p => p._id !== pitchId);
                    setCachedData('pitches', pitches);
                    updatePitchStats();
                    displayEvents();
                    alert('ãƒ”ãƒƒãƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                } else {
                    alert('ãƒ”ãƒƒãƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ãƒ”ãƒƒãƒå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ”ãƒƒãƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ğŸš€ æœ€é©åŒ–: æœ€è¿‘ã®ã‚®ãƒ•ãƒˆã‚’èª­ã¿è¾¼ã¿ï¼ˆè»½é‡åŒ–ï¼‰
        function loadRecentGifts() {
            recentGifts = [
                { id: 1, user: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼#4', amount: 100, timestamp: '2025/6/26 16:59:35', event: 'ã‚¤ãƒ™ãƒ³ãƒˆ#1' },
                { id: 2, user: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼#4', amount: 20,  timestamp: '2025/6/26 11:28:34', event: 'ã‚¤ãƒ™ãƒ³ãƒˆ#1' },
                { id: 3, user: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼#4', amount: 100, timestamp: '2025/6/26 11:28:22', event: 'ã‚¤ãƒ™ãƒ³ãƒˆ#1' }
            ];
        }

        // ğŸš€ æœ€é©åŒ–: æ™‚é–“è²¢çŒ®å±¥æ­´ã‚’è¡¨ç¤ºï¼ˆDocumentFragmentä½¿ç”¨ï¼‰
        function displayContributions() {
            const container = document.getElementById('contributions-list');
            const emptyState = document.getElementById('empty-contributions');
            
            if (!container || !emptyState) return;

            if (timeContributions.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            // ğŸš€ DocumentFragmentã‚’ä½¿ç”¨ï¼ˆé«˜é€ŸåŒ–ï¼‰
            const fragment = document.createDocumentFragment();
            
            timeContributions.forEach(contribution => {
                const div = document.createElement('div');
                div.className = 'contribution-item';
                div.innerHTML = createContributionItem(contribution);
                fragment.appendChild(div);
            });
            
            container.innerHTML = '';
            container.appendChild(fragment);
        }

        // ğŸš€ æœ€é©åŒ–: æ™‚é–“è²¢çŒ®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å‡¦ç†ï¼‰
        function createContributionItem(contribution) {
            const time = new Date(contribution.createdAt).toLocaleString('ja-JP');
            
            return `
                <div class="contribution-left">
                    <div class="contribution-avatar">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                        </svg>
                    </div>
                    <div class="contribution-info">
                        <div class="contribution-user">${contribution.userName}</div>
                        <div class="contribution-details">${contribution.type} â€“ ${contribution.hours}æ™‚é–“</div>
                        <div class="contribution-time">${time}</div>
                    </div>
                </div>
                <div class="contribution-amount">+${contribution.coins} QUcoin</div>
            `;
        }

        // ğŸš€ æœ€é©åŒ–: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆDocumentFragmentä½¿ç”¨ï¼‰
        function displayUsers() {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;
            
            // ğŸš€ DocumentFragmentã‚’ä½¿ç”¨ï¼ˆé«˜é€ŸåŒ–ï¼‰
            const fragment = document.createDocumentFragment();
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = createUserRow(user);
                fragment.appendChild(tr);
            });
            
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        // ğŸš€ æœ€é©åŒ–: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œã‚’ä½œæˆï¼ˆè¨ˆç®—ã‚’æœ€å°åŒ–ï¼‰
        function createUserRow(user) {
            const registrationDate = new Date(user.createdAt).toLocaleDateString('ja-JP');
            const roleBadges = getRoleBadges(user.role, user.team);
            const actionButton = user.role !== 'admin' ? 
                `<button class="delete-user-btn" onclick="handleDeleteUser('${user._id}', '${user.name}')">
                    <svg class="delete-user-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a6 6 0 1 0 0 12h6m-6-6h12"/>
                    </svg>
                </button>` : 
                '<span class="admin-label">ç®¡ç†è€…</span>';

            return `
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td class="balance">${(user.coinBalance || 0).toLocaleString()} QUcoin</td>
                <td>${registrationDate}</td>
                <td>${roleBadges}</td>
                <td>${actionButton}</td>
            `;
        }

        // ğŸš€ æœ€é©åŒ–: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¸ã‚’å–å¾—ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
        const roleConfigs = {
            admin: { class: 'role-admin', label: 'admin' },
            presenter: { class: 'role-presenter', label: 'presenter' },
            viewer: { class: 'role-viewer', label: 'viewer' }
        };

        function getRoleBadges(role, team) {
            const config = roleConfigs[role] || { class: 'role-viewer', label: role };
            let badges = `<span class="role-badge ${config.class}">${config.label}</span>`;
            
            if (team) {
                badges += `<span class="role-badge team-badge">${team}</span>`;
            }
            
            return `<div class="role-badges">${badges}</div>`;
        }

        // ğŸš€ æœ€é©åŒ–: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°å„ªå…ˆï¼‰
        async function handleDeleteUser(userId, name) {
            if (!confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'x-user-id': token,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // ğŸš€ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å³åº§ã«æ›´æ–°
                    users = users.filter(u => u._id !== userId);
                    setCachedData('users', users);
                    displayUsers();
                    
                    const totalUsersEl = document.getElementById('total-users');
                    if (totalUsersEl) {
                        totalUsersEl.textContent = `${users.length} äºº`;
                    }
                    
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                } else {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ğŸš€ æœ€é©åŒ–: å±¥æ­´ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°å„ªå…ˆï¼‰
        async function handleResetHistory() {
            if (!confirm('æ™‚é–“è²¢çŒ®å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/admin/reset-time-contributions', {
                    method: 'POST',
                    headers: {
                        'x-user-id': token,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // ğŸš€ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å³åº§ã«æ›´æ–°
                    timeContributions = [];
                    setCachedData('contributions', timeContributions);
                    displayContributions();
                    alert('å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
                } else {
                    alert('ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('å±¥æ­´ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ğŸš€ æœ€é©åŒ–: Socket.IOæ¥ç¶šã‚’åˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è»½é‡åŒ–ï¼‰
        function initializeSocket() {
            try {
                if (typeof io !== 'undefined') {
                    socket = io();
                    
                    // ğŸš€ Socket.ioã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’åŠ¹ç‡åŒ–
                    socket.on('total-coins-updated', (sum) => {
                        const el = document.getElementById('total-gifts');
                        if (el) el.textContent = `${sum.toLocaleString()} QUcoin`;
                    });

                    socket.on('pitch-created', (newPitch) => {
                        pitches.push(newPitch);
                        setCachedData('pitches', pitches);
                        updatePitchStats();
                        displayEvents();
                    });

                    socket.on('pitch-updated', (updatedPitch) => {
                        const index = pitches.findIndex(p => p._id === updatedPitch._id);
                        if (index !== -1) {
                            pitches[index] = updatedPitch;
                            setCachedData('pitches', pitches);
                            displayEvents();
                        }
                    });

                    socket.on('user-registered', (newUser) => {
                        users.push(newUser);
                        setCachedData('users', users);
                        displayUsers();
                        
                        const el = document.getElementById('total-users');
                        if (el) el.textContent = `${users.length} äºº`;
                    });
                }
            } catch (error) {
                console.log('Socket.IOæ¥ç¶šã‚’ã‚¹ã‚­ãƒƒãƒ—:', error);
            }
        }

        // ğŸš€ æœ€é©åŒ–: Socket.IOæ¥ç¶šã‚’åˆ‡æ–­
        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        // ğŸš€ æœ€é©åŒ–: ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰
        window.addEventListener('load', async () => {
            if (!checkAuth()) return;
            
            // ğŸš€ ä¸¦åˆ—ã§åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
            await Promise.all([
                loadAdminStats(),
                new Promise(resolve => {
                    initializeSocket();
                    resolve();
                })
            ]);
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        });

        // ğŸš€ æœ€é©åŒ–: ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®å‡¦ç†
        window.addEventListener('beforeunload', () => {
            disconnectSocket();
            dataCache.clear(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
        });
    </script>
</body>
</html>