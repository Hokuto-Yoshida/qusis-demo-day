<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者ダッシュボード - QUSIS デモデイ</title>
    <script src="js/header.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.5;
        }
        
        .container {
            max-width: 80rem;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .header {
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        @media (min-width: 640px) {
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header-icon {
            width: 2.5rem;
            height: 2.5rem;
            background: #eab308;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-icon svg {
            width: 1.5rem;
            height: 1.5rem;
            color: white;
        }
        
        .header-text h1 {
            font-size: 1.875rem;
            font-weight: bold;
            color: #111827;
        }
        
        .header-text p {
            color: #6b7280;
        }
        
        .reset-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #fef2f2;
            color: #b91c1c;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        
        .reset-button:hover {
            background: #fecaca;
        }
        
        .reset-icon {
            width: 1rem;
            height: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .pitch-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: #fafafa;
        }

        .pitch-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .pitch-info {
            flex: 1;
        }

        .pitch-title {
            font-size: 1.125rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .pitch-team {
            font-size: 0.875rem;
            color: #7c3aed;
            margin-bottom: 0.25rem;
        }

        .pitch-presenter {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .pitch-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }

        .pitch-stats .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .pitch-stats .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .pitch-stats .stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
        }

        .pitch-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-restart {
            background: #f59e0b;
            color: white;
        }

        .btn-restart:hover {
            background: #d97706;
        }

        /* ステータスバッジの色調整 */
        .status-badge.status-upcoming {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.status-live {
            background: #fef2f2;
            color: #dc2626;
            animation: pulse 2s infinite;
        }

        .status-badge.status-ended {
            background: #f3f4f6;
            color: #6b7280;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* レスポンシブ対応 */
        @media (max-width: 640px) {
            .pitch-header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .pitch-actions {
                justify-content: center;
            }
            
            .pitch-stats {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }

        .stat-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .stat-content p:first-child {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        
        .stat-value {
            font-size: 1.875rem;
            font-weight: bold;
            color: #111827;
        }
        
        .stat-icon {
            width: 2rem;
            height: 2rem;
        }
        
        .stat-icon.green {
            color: #16a34a;
        }
        
        .stat-icon.blue {
            color: #2563eb;
        }
        
        .stat-icon.purple {
            color: #7c3aed;
        }
        
        .stat-icon.orange {
            color: #ea580c;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        @media (min-width: 1024px) {
            .main-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .panel {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .panel-icon {
            width: 1.25rem;
            height: 1.25rem;
        }
        
        .panel-icon.purple {
            color: #7c3aed;
        }
        
        .panel-icon.green {
            color: #16a34a;
        }
        
        .panel-icon.gray {
            color: #6b7280;
        }
        
        .panel-icon.blue {
            color: #2563eb;
        }
        
        .panel-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #111827;
        }
        
        .panel-content {
            padding: 1.5rem;
        }
        
        .event-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .event-title {
            font-weight: 600;
            color: #111827;
        }
        
        .event-team {
            font-size: 0.875rem;
            color: #7c3aed;
        }
        
        .event-status {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
        }
        
        .event-status.live {
            background: #fef2f2;
            color: #b91c1c;
        }
        
        .event-status.ended {
            background: #f3f4f6;
            color: #1f2937;
        }
        
        .event-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .event-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            border: none;
        }
        
        .btn-start {
            background: #16a34a;
            color: white;
        }
        
        .btn-start:hover {
            background: #15803d;
        }
        
        .btn-end {
            background: #dc2626;
            color: white;
        }
        
        .btn-end:hover {
            background: #b91c1c;
        }
        
        .btn-delete {
            background: #fef2f2;
            color: #b91c1c;
        }
        
        .btn-delete:hover {
            background: #fecaca;
        }
        
        .btn-icon {
            width: 0.75rem;
            height: 0.75rem;
        }
        
        .gift-list {
            max-height: 20rem;
            overflow-y: auto;
        }
        
        .gift-item {
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .gift-item:last-child {
            border-bottom: none;
        }
        
        .gift-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .gift-avatar {
            width: 2rem;
            height: 2rem;
            background: #dbeafe;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gift-avatar svg {
            width: 1rem;
            height: 1rem;
            color: #2563eb;
        }
        
        .gift-info {
            display: flex;
            flex-direction: column;
        }
        
        .gift-user {
            font-weight: 500;
            color: #111827;
        }
        
        .gift-time {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .gift-right {
            text-align: right;
        }
        
        .gift-amount {
            font-size: 1.125rem;
            font-weight: bold;
            color: #16a34a;
        }
        
        .gift-event {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .contribution-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .contribution-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .contribution-avatar {
            width: 2.5rem;
            height: 2.5rem;
            background: #f0fdfa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .contribution-avatar svg {
            width: 1.25rem;
            height: 1.25rem;
            color: #14b8a6;
        }
        
        .contribution-info {
            display: flex;
            flex-direction: column;
        }
        
        .contribution-user {
            font-weight: 500;
            color: #111827;
        }
        
        .contribution-details {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .contribution-time {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .contribution-amount {
            font-size: 1.125rem;
            font-weight: bold;
            color: #14b8a6;
        }
        
        .user-table {
            width: 100%;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f9fafb;
        }
        
        th {
            padding: 0.75rem 1.5rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        tbody {
            background: white;
        }
        
        td {
            padding: 1rem 1.5rem;
            white-space: nowrap;
            border-bottom: 1px solid #e5e7eb;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .role-badges {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .role-admin {
            background: #fef2f2;
            color: #b91c1c;
        }
        
        .role-presenter {
            background: #f0fdf4;
            color: #166534;
        }
        
        .role-viewer {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .team-badge {
            background: #f3e8ff;
            color: #7c3aed;
        }
        
        .balance {
            color: #16a34a;
            font-weight: 600;
        }
        
        .delete-user-btn {
            color: #dc2626;
            background: none;
            border: none;
            padding: 0.25rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .delete-user-btn:hover {
            background: #fef2f2;
            color: #b91c1c;
        }
        
        .delete-user-icon {
            width: 1rem;
            height: 1rem;
        }
        
        .admin-label {
            color: #9ca3af;
            font-size: 0.875rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem 0;
            color: #6b7280;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 2rem;
            height: 2rem;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #14b8a6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div class="header-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                        </svg>
                    </div>
                    <div class="header-text">
                        <h1>QUcoin 運営ダッシュボード</h1>
                        <p>QUSIS ゼロイチピッチイベント管理</p>
                    </div>
                </div>
                <button class="reset-button" onclick="handleResetHistory()">
                    <svg class="reset-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <span>履歴リセット</span>
                </button>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-content">
                        <p>総ギフト額</p>
                        <p class="stat-value" id="total-gifts">0 QUcoin</p>
                    </div>
                    <svg class="stat-icon green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <p>登録ユーザー数</p>
                        <p class="stat-value" id="total-users">0 人</p>
                    </div>
                    <svg class="stat-icon blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                    </svg>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <p>登録済みピッチ数</p>
                        <p class="stat-value" id="total-pitches">0 件</p>
                    </div>
                    <svg class="stat-icon purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                </div>
            </div>

            <div class="main-grid">
                <!-- Pitch Management Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <svg class="panel-icon purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <h2 class="panel-title">ピッチ管理</h2>
                    </div>
                    <div class="panel-content">
                        <div id="pitches-list">
                            <!-- Pitches will be inserted here -->
                        </div>
                        <div id="empty-pitches" class="empty-state hidden">
                            登録されているピッチはありません
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Contribution History -->
            <div class="panel" style="margin-bottom: 2rem;">
                <div class="panel-header">
                    <svg class="panel-icon gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h2 class="panel-title">時間貢献履歴</h2>
                </div>
                <div class="panel-content">
                    <div id="contributions-list">
                        <!-- Contributions will be inserted here -->
                    </div>
                    <div id="empty-contributions" class="empty-state hidden">
                        時間貢献を行ったユーザーはまだいません
                    </div>
                </div>
            </div>

            <!-- User Management -->
            <div class="panel">
                <div class="panel-header">
                    <svg class="panel-icon blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                    </svg>
                    <h2 class="panel-title">ユーザー管理</h2>
                </div>
                <div class="panel-content">
                    <div class="user-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ユーザー名</th>
                                    <th>メール</th>
                                    <th>残高</th>
                                    <th>登録日</th>
                                    <th>ステータス</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Users will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let currentUser = null;
        let pitches = [];
        let users = [];
        let recentGifts = [];
        let timeContributions = [];
        let socket = null;

        // キャッシュシステム（高速化）
        let dataCache = {
            gifts: { data: null, timestamp: 0 },
            users: { data: null, timestamp: 0 },
            pitches: { data: null, timestamp: 0 },
            contributions: { data: null, timestamp: 0 }
        };
        const CACHE_DURATION = 60000; // 1分間キャッシュ

        // 認証チェック（高速化）
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const userStr = localStorage.getItem('user');
            
            if (!token || !userStr) {
                window.location.href = 'login.html';
                return false;
            }
            
            try {
                currentUser = JSON.parse(userStr);
                if (currentUser.role !== 'admin') {
                    alert('このページは管理者のみアクセス可能です');
                    window.location.href = 'home.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('ユーザー情報の解析に失敗:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
                return false;
            }
        }

        // キャッシュチェック関数（高速化）
        function getCachedData(key) {
            const cached = dataCache[key];
            const now = Date.now();
            
            if (cached.data && (now - cached.timestamp) < CACHE_DURATION) {
                return cached.data;
            }
            return null;
        }

        // キャッシュ更新関数（高速化）
        function setCachedData(key, data) {
            dataCache[key] = {
                data: data,
                timestamp: Date.now()
            };
        }

        // 管理者統計データを取得（高速化版）
        async function loadAdminStats() {
            try {
                const token = localStorage.getItem('authToken');
                
                // 並列でAPI呼び出し（高速化）
                const apiCalls = [];
                
                // キャッシュチェックして必要なAPIのみ呼び出し
                if (!getCachedData('gifts')) {
                    apiCalls.push(
                        fetch('/api/admin/total-coins', {
                            headers: {
                                'x-user-id': token,
                                'Content-Type': 'application/json'
                            }
                        }).then(res => res.ok ? res.json().then(data => ({type: 'gifts', data})) : null)
                    );
                }
                
                if (!getCachedData('users')) {
                    apiCalls.push(
                        fetch('/api/admin/users', {
                            headers: {
                                'x-user-id': token,
                                'Content-Type': 'application/json'
                            }
                        }).then(res => res.ok ? res.json().then(data => ({type: 'users', data})) : null)
                    );
                }
                
                if (!getCachedData('pitches')) {
                    apiCalls.push(
                        fetch('/api/pitches', {
                            headers: {
                                'x-user-id': token,
                                'Content-Type': 'application/json'
                            }
                        }).then(res => res.ok ? res.json().then(data => ({type: 'pitches', data})) : null)
                    );
                }
                
                if (!getCachedData('contributions')) {
                    apiCalls.push(
                        fetch('/api/admin/time-contributions', {
                            headers: {
                                'x-user-id': token,
                                'Content-Type': 'application/json'
                            }
                        }).then(res => res.ok ? res.json().then(data => ({type: 'contributions', data})) : null)
                    );
                }
                
                // 並列実行（高速化）
                const results = await Promise.all(apiCalls);
                
                // 結果の処理
                results.forEach(result => {
                    if (!result) return;
                    
                    setCachedData(result.type, result.data);
                    
                    switch (result.type) {
                        case 'gifts':
                            updateGiftsDisplay(result.data);
                            break;
                        case 'users':
                            updateUsersDisplay(result.data);
                            break;
                        case 'pitches':
                            updatePitchesDisplay(result.data);
                            break;
                        case 'contributions':
                            updateContributionsDisplay(result.data);
                            break;
                    }
                });
                
                // キャッシュからデータを使用
                const cachedGifts = getCachedData('gifts');
                const cachedUsers = getCachedData('users');
                const cachedPitches = getCachedData('pitches');
                const cachedContributions = getCachedData('contributions');
                
                if (cachedGifts) updateGiftsDisplay(cachedGifts);
                if (cachedUsers) updateUsersDisplay(cachedUsers);
                if (cachedPitches) updatePitchesDisplay(cachedPitches);
                if (cachedContributions) updateContributionsDisplay(cachedContributions);
                
                // サンプルギフトデータは最後に読み込み
                loadRecentGifts();
                
            } catch (error) {
                console.error('管理者データの取得エラー:', error);
            }
        }

        // 各表示更新関数（高速化）
        function updateGiftsDisplay(data) {
            const el = document.getElementById('total-gifts');
            if (el) el.textContent = `${data.total.toLocaleString()} QUcoin`;
        }

        function updateUsersDisplay(data) {
            users = data;
            const el = document.getElementById('total-users');
            if (el) el.textContent = `${users.length} 人`;
            displayUsers();
        }

        function updatePitchesDisplay(data) {
            pitches = data;
            updatePitchStats();
            displayEvents();
        }

        function updateContributionsDisplay(data) {
            timeContributions = data;
            displayContributions();
        }

        // ピッチ統計を更新（高速化）
        function updatePitchStats() {
            const totalPitches = pitches.length;
            const totalPitchesEl = document.getElementById('total-pitches');
            
            if (totalPitchesEl) {
                totalPitchesEl.textContent = `${totalPitches} 件`;
            }
        }

        // イベント一覧を表示（高速化）
        function displayEvents() {
            const container = document.getElementById('pitches-list');
            const emptyState = document.getElementById('empty-pitches');
            
            if (!container || !emptyState) return;

            if (pitches.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            // documentFragmentを使用（高速化）
            const fragment = document.createDocumentFragment();
            
            // 表示件数制限（高速化）
            const maxDisplay = 10;
            const displayPitches = pitches.slice(0, maxDisplay);
            
            displayPitches.forEach(pitch => {
                const pitchEl = createPitchElement(pitch);
                fragment.appendChild(pitchEl);
            });
            
            container.innerHTML = '';
            container.appendChild(fragment);
            
            // 残りの件数表示
            if (pitches.length > maxDisplay) {
                const moreEl = document.createElement('div');
                moreEl.className = 'pitch-item';
                moreEl.innerHTML = `
                    <div class="pitch-header">
                        <div class="pitch-info">
                            <h3 class="pitch-title">他 ${pitches.length - maxDisplay} 件のピッチがあります</h3>
                        </div>
                    </div>
                `;
                container.appendChild(moreEl);
            }
        }

        // ピッチ要素を作成（高速化）
        function createPitchElement(pitch) {
            const div = document.createElement('div');
            div.className = 'pitch-item';
            
            const statusInfo = getStatusInfo(pitch.status);
            
            div.innerHTML = `
                <div class="pitch-header">
                    <div class="pitch-info">
                        <h3 class="pitch-title">${pitch.title}</h3>
                        <p class="pitch-team">チーム: ${pitch.team || '未設定'}</p>
                    </div>
                    <span class="status-badge ${statusInfo.className}">${statusInfo.label}</span>
                </div>
                
                <div class="pitch-stats">
                    <div class="stat-item">
                        <span class="stat-label">ギフト総額</span>
                        <span class="stat-value">${pitch.totalTips || 0} QU</span>
                    </div>
                </div>
                
                <div class="pitch-actions">
                    ${getStatusButtons(pitch)}
                    <button class="btn btn-delete" onclick="handleDeletePitch('${pitch._id}', '${pitch.title}')">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        削除
                    </button>
                </div>
            `;
            
            return div;
        }

        // ステータス情報を取得
        function getStatusInfo(status) {
            switch (status) {
                case 'live':
                    return { label: 'ライブ中', className: 'status-live' };
                case 'ended':
                    return { label: '終了', className: 'status-ended' };
                default:
                    return { label: '未開始', className: 'status-upcoming' };
            }
        }

        // ステータスボタンを取得
        function getStatusButtons(pitch) {
            const buttons = [];
            
            if (pitch.status === 'upcoming') {
                buttons.push(`
                    <button class="btn btn-start" onclick="handleStatusChange('${pitch._id}', 'live')">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-10-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        開始
                    </button>
                `);
            }
            
            if (pitch.status === 'live') {
                buttons.push(`
                    <button class="btn btn-end" onclick="handleStatusChange('${pitch._id}', 'ended')">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        終了
                    </button>
                `);
            }
            
            if (pitch.status === 'ended') {
                buttons.push(`
                    <button class="btn btn-restart" onclick="handleStatusChange('${pitch._id}', 'upcoming')">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        リセット
                    </button>
                `);
            }
            
            return buttons.join('');
        }

        // ステータス変更（高速化版）
        async function handleStatusChange(pitchId, newStatus) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/pitches/${pitchId}`, {
                    method: 'PUT',
                    headers: {
                        'x-user-id': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    // ローカルデータを更新
                    const index = pitches.findIndex(p => p._id === pitchId);
                    if (index !== -1) {
                        pitches[index].status = newStatus;
                        setCachedData('pitches', pitches); // キャッシュ更新
                        updatePitchStats();
                        displayEvents();
                    }
                    
                    const statusText = {
                        'upcoming': '未開始',
                        'live': 'ライブ中',
                        'ended': '終了'
                    };
                    
                    alert(`ステータスを「${statusText[newStatus]}」に更新しました`);
                } else {
                    alert('ステータスの更新に失敗しました');
                }
            } catch (error) {
                console.error('ステータス更新エラー:', error);
                alert('ステータスの更新に失敗しました');
            }
        }

        // ピッチ削除（高速化版）
        async function handleDeletePitch(pitchId, title) {
            if (!confirm(`「${title}」を削除しますか？\n\n⚠️ この操作は取り消せません。関連する投げ銭データも削除されます。`)) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/pitches/${pitchId}`, {
                    method: 'DELETE',
                    headers: {
                        'x-user-id': token,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    pitches = pitches.filter(p => p._id !== pitchId);
                    setCachedData('pitches', pitches); // キャッシュ更新
                    updatePitchStats();
                    displayEvents();
                    alert('ピッチを削除しました');
                } else {
                    alert('ピッチの削除に失敗しました');
                }
            } catch (error) {
                console.error('ピッチ削除エラー:', error);
                alert('ピッチの削除に失敗しました');
            }
        }

        // 最近のギフトを読み込み（サンプルデータ）
        function loadRecentGifts() {
            // サンプルデータは軽量化
            recentGifts = [
                { id: 1, user: 'ユーザー#4', amount: 100, timestamp: '2025/6/26 16:59:35', event: 'イベント#1' },
                { id: 2, user: 'ユーザー#4', amount: 20,  timestamp: '2025/6/26 11:28:34', event: 'イベント#1' },
                { id: 3, user: 'ユーザー#4', amount: 100, timestamp: '2025/6/26 11:28:22', event: 'イベント#1' }
            ];
            displayGifts();
        }

        // ギフト一覧を表示（高速化）
        function displayGifts() {
            const container = document.getElementById('gifts-list');
            if (!container) return;
            
            // 表示件数制限（高速化）
            const maxDisplay = 5;
            const displayGifts = recentGifts.slice(0, maxDisplay);
            
            container.innerHTML = displayGifts.map(gift => createGiftItem(gift)).join('');
        }

        // ギフトアイテムを作成
        function createGiftItem(gift) {
            return `
                <div class="gift-item">
                    <div class="gift-left">
                        <div class="gift-avatar">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                            </svg>
                        </div>
                        <div class="gift-info">
                            <div class="gift-user">${gift.user}</div>
                            <div class="gift-time">${gift.timestamp}</div>
                        </div>
                    </div>
                    <div class="gift-right">
                        <div class="gift-amount">+${gift.amount} QUcoin</div>
                        <div class="gift-event">${gift.event}</div>
                    </div>
                </div>
            `;
        }

        // 時間貢献履歴を表示（高速化）
        function displayContributions() {
            const container = document.getElementById('contributions-list');
            const emptyState = document.getElementById('empty-contributions');
            
            if (!container || !emptyState) return;

            if (timeContributions.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            // 表示件数制限（高速化）
            const maxDisplay = 10;
            const displayContributions = timeContributions.slice(0, maxDisplay);
            
            container.innerHTML = displayContributions.map(contribution => createContributionItem(contribution)).join('');
            
            // 残りの件数表示
            if (timeContributions.length > maxDisplay) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'contribution-item';
                moreDiv.innerHTML = `
                    <div class="contribution-left">
                        <div class="contribution-info">
                            <div class="contribution-user">他 ${timeContributions.length - maxDisplay} 件の貢献履歴があります</div>
                        </div>
                    </div>
                `;
                container.appendChild(moreDiv);
            }
        }

        // 時間貢献アイテムを作成
        function createContributionItem(contribution) {
            const time = new Date(contribution.createdAt).toLocaleString('ja-JP');
            
            return `
                <div class="contribution-item">
                    <div class="contribution-left">
                        <div class="contribution-avatar">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                            </svg>
                        </div>
                        <div class="contribution-info">
                            <div class="contribution-user">${contribution.userName}</div>
                            <div class="contribution-details">${contribution.type} – ${contribution.hours}時間</div>
                            <div class="contribution-time">${time}</div>
                        </div>
                    </div>
                    <div class="contribution-amount">+${contribution.coins} QUcoin</div>
                </div>
            `;
        }

        // ユーザー一覧を表示（高速化）
        function displayUsers() {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;
            
            // 表示件数制限（高速化）
            const maxDisplay = 20;
            const displayUsers = users.slice(0, maxDisplay);
            
            tbody.innerHTML = displayUsers.map(user => createUserRow(user)).join('');
            
            // 残りの件数表示
            if (users.length > maxDisplay) {
                const moreRow = document.createElement('tr');
                moreRow.innerHTML = `
                    <td colspan="6" style="text-align: center; color: #6b7280;">
                        他 ${users.length - maxDisplay} 人のユーザーがあります
                    </td>
                `;
                tbody.appendChild(moreRow);
            }
        }

        // ユーザー行を作成
        function createUserRow(user) {
            const registrationDate = new Date(user.createdAt).toLocaleDateString('ja-JP');
            const roleBadges = getRoleBadges(user.role, user.team);
            const actionButton = user.role !== 'admin' ? 
                `<button class="delete-user-btn" onclick="handleDeleteUser('${user._id}', '${user.name}')">
                    <svg class="delete-user-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a6 6 0 1 0 0 12h6m-6-6h12"/>
                    </svg>
                </button>` : 
                '<span class="admin-label">管理者</span>';

            return `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td class="balance">${(user.coinBalance || 0).toLocaleString()} QUcoin</td>
                    <td>${registrationDate}</td>
                    <td>${roleBadges}</td>
                    <td>${actionButton}</td>
                </tr>
            `;
        }

        // ロールバッジを取得
        function getRoleBadges(role, team) {
            const roleConfigs = {
                admin: { class: 'role-admin', label: 'admin' },
                presenter: { class: 'role-presenter', label: 'presenter' },
                viewer: { class: 'role-viewer', label: 'viewer' }
            };

            const config = roleConfigs[role] || { class: 'role-viewer', label: role };
            let badges = `<span class="role-badge ${config.class}">${config.label}</span>`;
            
            if (team) {
                badges += `<span class="role-badge team-badge">${team}</span>`;
            }
            
            return `<div class="role-badges">${badges}</div>`;
        }

        // ユーザー削除（高速化版）
        async function handleDeleteUser(userId, name) {
            if (!confirm(`ユーザー「${name}」を削除しますか？`)) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'x-user-id': token,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    users = users.filter(u => u._id !== userId);
                    setCachedData('users', users); // キャッシュ更新
                    displayUsers();
                    
                    const totalUsersEl = document.getElementById('total-users');
                    if (totalUsersEl) {
                        totalUsersEl.textContent = `${users.length} 人`;
                    }
                    
                    alert('ユーザーを削除しました');
                } else {
                    alert('ユーザーの削除に失敗しました');
                }
            } catch (error) {
                console.error('ユーザー削除エラー:', error);
                alert('ユーザーの削除に失敗しました');
            }
        }

        // 履歴リセット（高速化版）
        async function handleResetHistory() {
            if (!confirm('時間貢献履歴をリセットしますか？')) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/admin/reset-time-contributions', {
                    method: 'POST',
                    headers: {
                        'x-user-id': token,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    timeContributions = [];
                    setCachedData('contributions', timeContributions); // キャッシュ更新
                    displayContributions();
                    alert('履歴をリセットしました');
                } else {
                    alert('リセットに失敗しました');
                }
            } catch (error) {
                console.error('履歴リセットエラー:', error);
                alert('リセットに失敗しました');
            }
        }

        // Socket.IO接続を初期化（高速化）
        function initializeSocket() {
            try {
                if (typeof io !== 'undefined') {
                    socket = io();
                    
                    socket.on('total-coins-updated', (sum) => {
                        const el = document.getElementById('total-gifts');
                        if (el) el.textContent = `${sum.toLocaleString()} QUcoin`;
                    });

                    socket.on('pitch-created', (newPitch) => {
                        pitches.push(newPitch);
                        setCachedData('pitches', pitches);
                        updatePitchStats();
                        displayEvents();
                    });

                    socket.on('pitch-updated', (updatedPitch) => {
                        const index = pitches.findIndex(p => p._id === updatedPitch._id);
                        if (index !== -1) {
                            pitches[index] = updatedPitch;
                            setCachedData('pitches', pitches);
                            updatePitchStats();
                            displayEvents();
                        }
                    });

                    socket.on('user-registered', (newUser) => {
                        users.push(newUser);
                        setCachedData('users', users);
                        displayUsers();
                        
                        const el = document.getElementById('total-users');
                        if (el) el.textContent = `${users.length} 人`;
                    });
                }
            } catch (error) {
                console.log('Socket.IO接続をスキップ:', error);
            }
        }

        // Socket.IO接続を切断
        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
            }
        }

        // ページ読み込み時の初期化（高速化）
        window.addEventListener('load', async () => {
            if (!checkAuth()) return;
            
            await loadAdminStats();
            initializeSocket();
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        });

        // ページ離脱時の処理
        window.addEventListener('beforeunload', () => {
            disconnectSocket();
        });
    </script>
</body>
</html>